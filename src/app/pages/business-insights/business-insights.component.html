<div class="space-y-6 text-white/85">
  <!-- Header -->
  <div
    class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between"
  >
    <div>
      <h1 class="text-2xl font-bold text-white">Business Insights</h1>
      <p class="text-sm text-white/60 mt-1">
        Analytics and reporting for projects, resources, and performance
      </p>
    </div>
    <div class="flex items-center gap-3">
      <button
        ubButton
        size="sm"
        variant="secondary"
        class="border border-white/20 bg-white/5 hover:bg-white/10"
        (click)="exportToCSV()"
        [disabled]="loading() || !insights()"
      >
        Export CSV
      </button>
      <button
        ubButton
        size="sm"
        variant="secondary"
        class="border border-white/20 bg-white/5 hover:bg-white/10"
        (click)="exportToPDF()"
        [disabled]="loading() || !insights()"
      >
        Export PDF
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div
    class="rounded-[26px] border border-white/10 bg-white/5/80 p-6 shadow-[0_35px_90px_rgba(9,14,33,0.55)] backdrop-blur-xl"
  >
    <form
      [formGroup]="filterForm"
      (ngSubmit)="onFilterChange()"
      class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4"
    >
      <div>
        <label
          class="mb-2 block text-xs uppercase tracking-[0.35em] text-white/60"
        >
          Date Range
        </label>
        <select
          formControlName="dateRange"
          (change)="onFilterChange()"
          class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-white/80 outline-none transition focus:border-primary/60 focus:bg-white/10 focus:text-white"
        >
          <option value="all">All Time</option>
          <option value="last30">Last 30 Days</option>
          <option value="last90">Last 90 Days</option>
          <option value="last365">Last Year</option>
          <option value="custom">Custom Range</option>
        </select>
      </div>
      <div *ngIf="filterForm.get('dateRange')?.value === 'custom'">
        <label
          class="mb-2 block text-xs uppercase tracking-[0.35em] text-white/60"
        >
          Start Date
        </label>
        <input
          type="date"
          formControlName="startDate"
          (change)="onFilterChange()"
          class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-white/80 outline-none transition focus:border-primary/60 focus:bg-white/10 focus:text-white"
        />
      </div>
      <div *ngIf="filterForm.get('dateRange')?.value === 'custom'">
        <label
          class="mb-2 block text-xs uppercase tracking-[0.35em] text-white/60"
        >
          End Date
        </label>
        <input
          type="date"
          formControlName="endDate"
          (change)="onFilterChange()"
          class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-white/80 outline-none transition focus:border-primary/60 focus:bg-white/10 focus:text-white"
        />
      </div>
      <div>
        <label
          class="mb-2 block text-xs uppercase tracking-[0.35em] text-white/60"
        >
          Department
        </label>
        <select
          formControlName="department"
          (change)="onFilterChange()"
          class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-white/80 outline-none transition focus:border-primary/60 focus:bg-white/10 focus:text-white"
        >
          <option value="all">All Departments</option>
          <option *ngFor="let dept of departmentsSignal()" [value]="dept">
            {{ dept }}
          </option>
        </select>
      </div>
    </form>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading()" class="flex items-center justify-center py-12">
    <div class="text-center">
      <div
        class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-primary border-r-transparent"
      ></div>
      <p class="mt-4 text-sm text-white/60">Loading insights...</p>
    </div>
  </div>

  <!-- Tabs -->
  <div *ngIf="!loading() && insights()" class="space-y-6">
    <div class="flex gap-2 border-b border-white/10">
      <button
        type="button"
        (click)="setActiveTab('overview')"
        [ngClass]="{
          'border-b-2 border-primary text-white': activeTab() === 'overview',
          'text-white/60': activeTab() !== 'overview'
        }"
        class="px-4 py-2 text-sm font-medium transition-colors hover:text-white"
      >
        Overview
      </button>
      <button
        type="button"
        (click)="setActiveTab('projects')"
        [ngClass]="{
          'border-b-2 border-primary text-white': activeTab() === 'projects',
          'text-white/60': activeTab() !== 'projects'
        }"
        class="px-4 py-2 text-sm font-medium transition-colors hover:text-white"
      >
        Projects
      </button>
      <button
        type="button"
        (click)="setActiveTab('resources')"
        [ngClass]="{
          'border-b-2 border-primary text-white': activeTab() === 'resources',
          'text-white/60': activeTab() !== 'resources'
        }"
        class="px-4 py-2 text-sm font-medium transition-colors hover:text-white"
      >
        Resources
      </button>
      <button
        type="button"
        (click)="setActiveTab('financials')"
        [ngClass]="{
          'border-b-2 border-primary text-white': activeTab() === 'financials',
          'text-white/60': activeTab() !== 'financials'
        }"
        class="px-4 py-2 text-sm font-medium transition-colors hover:text-white"
      >
        Financials
      </button>
    </div>

    <!-- Overview Tab -->
    <div *ngIf="activeTab() === 'overview'" class="space-y-6">
      <!-- Key Metrics Cards -->
      <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <div
          class="rounded-2xl border border-white/10 bg-white/5 px-6 py-5 backdrop-blur-xl"
        >
          <p class="text-xs uppercase tracking-[0.3em] text-white/45">
            Total Projects
          </p>
          <p class="mt-2 text-3xl font-bold text-white">
            {{ insights()?.totalProjectCount ?? projectsSignal().length }}
          </p>
        </div>
        <div
          class="rounded-2xl border border-white/10 bg-white/5 px-6 py-5 backdrop-blur-xl"
        >
          <p class="text-xs uppercase tracking-[0.3em] text-white/45">
            Total Employees
          </p>
          <p class="mt-2 text-3xl font-bold text-white">
            {{
              (insights()?.filteredEmployeeCount ??
                insights()?.resourceUtilization?.totalEmployees) || 0
            }}
          </p>
        </div>
        <div
          class="rounded-2xl border border-white/10 bg-white/5 px-6 py-5 backdrop-blur-xl"
        >
          <p class="text-xs uppercase tracking-[0.3em] text-white/45">
            Avg Readiness
          </p>
          <p class="mt-2 text-3xl font-bold text-white">
            {{ insights()?.readinessScores?.average || 0 }}%
          </p>
        </div>
        <div
          class="rounded-2xl border border-white/10 bg-white/5 px-6 py-5 backdrop-blur-xl"
        >
          <p class="text-xs uppercase tracking-[0.3em] text-white/45">
            Resource Utilization
          </p>
          <p class="mt-2 text-3xl font-bold text-white">
            {{ insights()?.teamCapacity?.utilizationPercentage || 0 }}%
          </p>
        </div>
      </div>
      
      <!-- Project Breakdown Badges - Full Width Row Below Cards -->
      <div class="rounded-2xl border border-white/10 bg-white/5 px-6 py-4 backdrop-blur-xl">
        <div class="flex flex-wrap gap-2 items-center">
          <span
            class="inline-flex items-center rounded-full bg-cyan-500/20 px-2 py-0.5 text-xs font-medium text-cyan-400 border border-cyan-500/30"
            title="Non-archived projects (used for all calculations below)"
          >
            {{ insights()?.filteredProjectCount ?? 0 }} Non-Archived
          </span>
          <span
            *ngIf="(insights()?.archivedProjectCount ?? 0) > 0"
            class="inline-flex items-center rounded-full bg-gray-500/20 px-2 py-0.5 text-xs font-medium text-gray-400 border border-gray-500/30"
            title="Archived projects (excluded from calculations, display only)"
          >
            {{ insights()?.archivedProjectCount ?? 0 }} Archived
          </span>
          <span
            class="inline-flex items-center rounded-full bg-green-500/20 px-2 py-0.5 text-xs font-medium text-green-400 border border-green-500/30"
            title="Projects with active assignments or leads"
          >
            {{ insights()?.activeProjectCount ?? 0 }} Active
          </span>
          <span
            class="inline-flex items-center rounded-full bg-slate-500/20 px-2 py-0.5 text-xs font-medium text-slate-400 border border-slate-500/30"
            title="Projects with no active assignments and no lead"
          >
            {{ insights()?.inactiveProjectCount ?? 0 }} Inactive
          </span>
          <span
            *ngIf="(insights()?.planningProjectCount ?? 0) > 0"
            class="inline-flex items-center rounded-full bg-blue-500/20 px-2 py-0.5 text-xs font-medium text-blue-400 border border-blue-500/30"
            title="Projects with lead but no active assignments (planning/startup phase)"
          >
            {{ insights()?.planningProjectCount ?? 0 }} Planning
          </span>
          <span
            *ngIf="(insights()?.assignedProjectCount ?? 0) > 0"
            class="inline-flex items-center rounded-full bg-purple-500/20 px-2 py-0.5 text-xs font-medium text-purple-400 border border-purple-500/30"
            title="Projects with active employee assignments"
          >
            {{ insights()?.assignedProjectCount ?? 0 }} Assigned
          </span>
          <span
            *ngIf="(insights()?.nonAssignedProjectCount ?? 0) > 0"
            class="inline-flex items-center rounded-full bg-orange-500/20 px-2 py-0.5 text-xs font-medium text-orange-400 border border-orange-500/30"
            title="Projects with no active employee assignments"
          >
            {{ insights()?.nonAssignedProjectCount ?? 0 }} Non-Assigned
          </span>
        </div>
      </div>

      <!-- Project Status Distribution Chart -->
      <div
        class="rounded-[26px] border border-white/10 bg-white/5/80 p-6 shadow-[0_35px_90px_rgba(9,14,33,0.55)] backdrop-blur-xl"
      >
        <h2 class="mb-4 text-lg font-semibold text-white">
          Project Status Distribution
        </h2>
        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-5">
          <div
            *ngFor="
              let item of [
                {
                  label: 'Draft',
                  value: insights()?.projectStatusDistribution?.draft || 0,
                  color: 'bg-slate-500'
                },
                {
                  label: 'In Progress',
                  value:
                    insights()?.projectStatusDistribution?.in_progress || 0,
                  color: 'bg-blue-500'
                },
                {
                  label: 'Completed',
                  value: insights()?.projectStatusDistribution?.completed || 0,
                  color: 'bg-green-500'
                },
                {
                  label: 'On Hold',
                  value: insights()?.projectStatusDistribution?.on_hold || 0,
                  color: 'bg-yellow-500'
                },
                {
                  label: 'Cancelled',
                  value: insights()?.projectStatusDistribution?.cancelled || 0,
                  color: 'bg-red-500'
                }
              ]
            "
            class="rounded-2xl border border-white/10 bg-white/5 px-4 py-4 backdrop-blur-xl"
          >
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs text-white/60">{{ item.label }}</p>
                <p class="mt-1 text-2xl font-bold text-white">
                  {{ item.value }}
                </p>
              </div>
              <div
                [class]="'h-12 w-12 rounded-full ' + item.color + ' opacity-20'"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Readiness Score Distribution -->
      <div
        class="rounded-[26px] border border-white/10 bg-white/5/80 p-6 shadow-[0_35px_90px_rgba(9,14,33,0.55)] backdrop-blur-xl"
      >
        <h2 class="mb-4 text-lg font-semibold text-white">
          Readiness Score Distribution
        </h2>
        <div class="space-y-3">
          <div
            *ngFor="let dist of insights()?.readinessScores?.distribution || []"
            class="flex items-center gap-4"
          >
            <div class="w-24 text-sm text-white/60">{{ dist.range }}</div>
            <div class="flex-1">
              <div class="h-6 rounded-full bg-white/10">
                <div
                  class="h-6 rounded-full bg-gradient-to-r from-primary to-purple-500 transition-all"
                  [style.width.%]="
                    (dist.count /
                      (insights()?.filteredProjectCount ||
                        projectsSignal().length ||
                        1)) *
                    100
                  "
                ></div>
              </div>
            </div>
            <div class="w-12 text-right text-sm font-semibold text-white">
              {{ dist.count }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Projects Tab -->
    <div *ngIf="activeTab() === 'projects'" class="space-y-6">
      <div
        class="rounded-[26px] border border-white/10 bg-white/5/80 p-6 shadow-[0_35px_90px_rgba(9,14,33,0.55)] backdrop-blur-xl"
      >
        <h2 class="mb-4 text-lg font-semibold text-white">
          Department Breakdown
        </h2>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-white/10 text-left">
                <th
                  class="pb-3 text-xs uppercase tracking-[0.3em] text-white/60"
                >
                  Department
                </th>
                <th
                  class="pb-3 text-xs uppercase tracking-[0.3em] text-white/60"
                >
                  Employees
                </th>
                <th
                  class="pb-3 text-xs uppercase tracking-[0.3em] text-white/60"
                >
                  Projects
                </th>
                <th
                  class="pb-3 text-xs uppercase tracking-[0.3em] text-white/60"
                >
                  Avg Readiness
                </th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let dept of insights()?.departmentBreakdown || []"
                class="border-b border-white/5"
              >
                <td class="py-3 font-medium text-white">
                  {{ dept.department }}
                </td>
                <td class="py-3 text-white/80">{{ dept.employeeCount }}</td>
                <td class="py-3 text-white/80">{{ dept.projectCount }}</td>
                <td class="py-3">
                  <span
                    class="inline-flex rounded-full bg-primary/20 px-3 py-1 text-xs text-primary"
                  >
                    {{ dept.averageReadiness }}%
                  </span>
                </td>
              </tr>
              <tr *ngIf="!insights()?.departmentBreakdown?.length">
                <td colspan="4" class="py-8 text-center text-sm text-white/60">
                  No department data available for the selected filters.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div
        class="rounded-[26px] border border-white/10 bg-white/5/80 p-6 shadow-[0_35px_90px_rgba(9,14,33,0.55)] backdrop-blur-xl"
      >
        <h2 class="mb-4 text-lg font-semibold text-white">
          Project Type Breakdown
        </h2>
        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
          <div
            *ngFor="let type of insights()?.projectTypeBreakdown || []"
            class="rounded-2xl border border-white/10 bg-white/5 px-4 py-4 backdrop-blur-xl"
          >
            <p class="text-sm font-medium text-white">{{ type.type }}</p>
            <p class="mt-2 text-2xl font-bold text-white">{{ type.count }}</p>
            <p class="mt-1 text-xs text-white/60">
              Avg Readiness: {{ type.averageReadiness }}%
            </p>
          </div>
        </div>
        <div
          *ngIf="!insights()?.projectTypeBreakdown?.length"
          class="rounded-2xl border border-dashed border-white/20 bg-white/5 px-6 py-12 text-center"
        >
          <p class="text-sm text-white/60">
            No project type data available for the selected filters.
          </p>
        </div>
      </div>
    </div>

    <!-- Resources Tab -->
    <div *ngIf="activeTab() === 'resources'" class="space-y-6">
      <div
        class="rounded-[26px] border border-white/10 bg-white/5/80 p-6 shadow-[0_35px_90px_rgba(9,14,33,0.55)] backdrop-blur-xl"
      >
        <h2 class="mb-4 text-lg font-semibold text-white">
          Resource Utilization
        </h2>
        <div class="grid gap-4 sm:grid-cols-2">
          <div
            class="rounded-2xl border border-white/10 bg-white/5 px-4 py-4 backdrop-blur-xl"
          >
            <p class="text-xs text-white/60">Total Employees</p>
            <p class="mt-2 text-3xl font-bold text-white">
              {{ insights()?.resourceUtilization?.totalEmployees || 0 }}
            </p>
          </div>
          <div
            class="rounded-2xl border border-white/10 bg-white/5 px-4 py-4 backdrop-blur-xl"
          >
            <p class="text-xs text-white/60">Active Assignments</p>
            <p class="mt-2 text-3xl font-bold text-white">
              {{ insights()?.resourceUtilization?.activeAssignments || 0 }}
            </p>
          </div>
          <div
            class="rounded-2xl border border-white/10 bg-white/5 px-4 py-4 backdrop-blur-xl"
          >
            <p class="text-xs text-white/60">Average Allocation</p>
            <p class="mt-2 text-3xl font-bold text-white">
              {{ insights()?.resourceUtilization?.averageAllocation || 0 }}%
            </p>
          </div>
          <div
            class="rounded-2xl border border-white/10 bg-white/5 px-4 py-4 backdrop-blur-xl"
          >
            <p class="text-xs text-white/60">Available Resources</p>
            <p class="mt-2 text-3xl font-bold text-white">
              {{ insights()?.resourceUtilization?.availableCount || 0 }}
            </p>
          </div>
        </div>
      </div>

      <div
        class="rounded-[26px] border border-white/10 bg-white/5/80 p-6 shadow-[0_35px_90px_rgba(9,14,33,0.55)] backdrop-blur-xl"
      >
        <h2 class="mb-4 text-lg font-semibold text-white">Team Capacity</h2>
        <div class="space-y-4">
          <div>
            <div class="mb-2 flex items-center justify-between text-sm">
              <span class="text-white/60">Utilization</span>
              <span class="font-semibold text-white">
                {{ insights()?.teamCapacity?.utilizationPercentage || 0 }}%
              </span>
            </div>
            <div class="h-4 rounded-full bg-white/10">
              <div
                class="h-4 rounded-full bg-gradient-to-r from-primary to-purple-500 transition-all"
                [style.width.%]="
                  insights()?.teamCapacity?.utilizationPercentage || 0
                "
              ></div>
            </div>
          </div>
          <div class="grid gap-4 sm:grid-cols-3">
            <div>
              <p class="text-xs text-white/60">Total Capacity</p>
              <p class="mt-1 text-xl font-bold text-white">
                {{ insights()?.teamCapacity?.totalCapacity || 0 }}%
              </p>
            </div>
            <div>
              <p class="text-xs text-white/60">Utilized</p>
              <p class="mt-1 text-xl font-bold text-white">
                {{ insights()?.teamCapacity?.utilizedCapacity || 0 }}%
              </p>
            </div>
            <div>
              <p class="text-xs text-white/60">Available</p>
              <p class="mt-1 text-xl font-bold text-white">
                {{ insights()?.teamCapacity?.availableCapacity || 0 }}%
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Financials Tab -->
    <div *ngIf="activeTab() === 'financials'" class="space-y-6">
      <div
        class="rounded-[26px] border border-white/10 bg-white/5/80 p-6 shadow-[0_35px_90px_rgba(9,14,33,0.55)] backdrop-blur-xl"
      >
        <h2 class="mb-4 text-lg font-semibold text-white">Budget Metrics</h2>
        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
          <div
            class="rounded-2xl border border-white/10 bg-white/5 px-4 py-4 backdrop-blur-xl"
          >
            <p class="text-xs text-white/60">Total Budget</p>
            <p class="mt-2 text-2xl font-bold text-white">
              ${{
                insights()?.budgetMetrics?.totalBudget || 0 | number : "1.0-0"
              }}
            </p>
          </div>
          <div
            class="rounded-2xl border border-white/10 bg-white/5 px-4 py-4 backdrop-blur-xl"
          >
            <p class="text-xs text-white/60">Allocated</p>
            <p class="mt-2 text-2xl font-bold text-white">
              ${{
                insights()?.budgetMetrics?.allocatedBudget || 0
                  | number : "1.0-0"
              }}
            </p>
          </div>
          <div
            class="rounded-2xl border border-white/10 bg-white/5 px-4 py-4 backdrop-blur-xl"
          >
            <p class="text-xs text-white/60">Spent</p>
            <p class="mt-2 text-2xl font-bold text-white">
              ${{
                insights()?.budgetMetrics?.spentBudget || 0 | number : "1.0-0"
              }}
            </p>
          </div>
          <div
            class="rounded-2xl border border-white/10 bg-white/5 px-4 py-4 backdrop-blur-xl"
          >
            <p class="text-xs text-white/60">Remaining</p>
            <p class="mt-2 text-2xl font-bold text-white">
              ${{
                insights()?.budgetMetrics?.remainingBudget || 0
                  | number : "1.0-0"
              }}
            </p>
          </div>
        </div>
      </div>

      <!-- Budget Management Status Info -->
      <div
        class="rounded-[26px] border border-blue-500/20 bg-blue-500/5 p-6 shadow-[0_35px_90px_rgba(9,14,33,0.55)] backdrop-blur-xl"
      >
        <div class="flex items-start gap-4">
          <div class="flex-shrink-0">
            <svg
              class="h-6 w-6 text-blue-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
          </div>
          <div class="flex-1">
            <h3 class="mb-2 text-sm font-semibold text-blue-300">
              Budget Management Status
            </h3>
            <div class="space-y-2 text-sm text-white/70">
              <p>
                Currently, budget and finance-related management features are
                properly defined and implemented as follows:
              </p>
              <ul class="ml-4 list-disc space-y-1">
                <li>
                  <span class="font-medium text-green-400">✓</span> Budget data
                  is stored in seed data and database
                </li>
                <li>
                  <span class="font-medium text-green-400">✓</span> Budget data
                  is returned via API endpoints
                </li>
                <li>
                  <span class="font-medium text-green-400">✓</span> Budget
                  metrics are calculated dynamically from database
                </li>
                <li>
                  <span class="font-medium text-yellow-400">○</span> Budget
                  editing/input from frontend UI is not yet implemented
                </li>
              </ul>
              <p class="mt-3 text-xs text-white/50">
                Budget values are currently read-only and managed through the
                database. Frontend editing capabilities will be added in a
                future update.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
